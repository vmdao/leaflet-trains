/* leaflet-trains - v1.0.14 - Sat Sep 22 2018 17:13:39 GMT+0700 (Indochina Time)
 * Copyright (c) 2018 Environmental Systems Research Institute, Inc.
 * Apache-2.0 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet"],e):e((t.L=t.L||{},t.L.enouvo={}),t.L)}(this,function(t,e){"use strict";var i=window.XMLHttpRequest&&"withCredentials"in new window.XMLHttpRequest,s={cors:i,pointerEvents:""===document.documentElement.style.pointerEvents},n={attributionWidthOffset:55},r=0;function o(t){var e="";for(var i in t.f=t.f||"json",t)if(t.hasOwnProperty(i)){var s,n=t[i],r=Object.prototype.toString.call(n);e.length&&(e+="&"),s="[object Array]"===r?"[object Object]"===Object.prototype.toString.call(n[0])?JSON.stringify(n):n.join(","):"[object Object]"===r?JSON.stringify(n):"[object Date]"===r?n.valueOf():n,e+=encodeURIComponent(i)+"="+encodeURIComponent(s)}return e}function a(t,i){var s=new window.XMLHttpRequest;return s.onerror=function(n){s.onreadystatechange=e.Util.falseFn,t.call(i,{error:{code:500,message:"XMLHttpRequest error"}},null)},s.onreadystatechange=function(){var n,r;if(4===s.readyState){try{n=JSON.parse(s.responseText)}catch(t){n=null,r={code:500,message:"Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error."}}!r&&n.error&&(r=n.error,n=null),s.onerror=e.Util.falseFn,t.call(i,r,n)}},s.ontimeout=function(){this.onerror()},s}function l(t,e,i,s){var n=a(i,s);return n.open("POST",t),void 0!==s&&null!==s&&void 0!==s.options&&(n.timeout=s.options.timeout),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),n.send(o(e)),n}function u(t,e,i,s){var n=a(i,s);return n.open("GET",t+"?"+o(e),!0),void 0!==s&&null!==s&&void 0!==s.options&&(n.timeout=s.options.timeout),n.send(null),n}function h(t,e,i,n){var r=o(e),l=a(i,n),u=(t+"?"+r).length;if(u<=2e3&&s.cors?l.open("GET",t+"?"+r):u>2e3&&s.cors&&(l.open("POST",t),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),void 0!==n&&null!==n&&void 0!==n.options&&(l.timeout=n.options.timeout),u<=2e3&&s.cors)l.send(null);else{if(!(u>2e3&&s.cors))return u<=2e3&&!s.cors?c(t,e,i,n):void z("a request to "+t+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html");l.send(r)}return l}function c(t,i,s,n){window._EsriLeafletCallbacks=window._EsriLeafletCallbacks||{};var a="c"+r;i.callback="window._EsriLeafletCallbacks."+a,window._EsriLeafletCallbacks[a]=function(t){if(!0!==window._EsriLeafletCallbacks[a]){var e,i=Object.prototype.toString.call(t);"[object Object]"!==i&&"[object Array]"!==i&&(e={error:{code:500,message:"Expected array or object as JSONP response"}},t=null),!e&&t.error&&(e=t,t=null),s.call(n,e,t),window._EsriLeafletCallbacks[a]=!0}};var l=e.DomUtil.create("script",null,document.body);return l.type="text/javascript",l.src=t+"?"+o(i),l.id=a,l.onerror=function(t){if(t&&!0!==window._EsriLeafletCallbacks[a]){s.call(n,{error:{code:500,message:"An unknown error occurred"}}),window._EsriLeafletCallbacks[a]=!0}},e.DomUtil.addClass(l,"esri-leaflet-jsonp"),r++,{id:a,url:l.src,abort:function(){window._EsriLeafletCallbacks._callback[a]({code:0,message:"Request aborted."})}}}var p=s.cors?u:c;p.CORS=u,p.JSONP=c;var d={request:h,get:p,post:l};function f(t){return function(t,e){for(var i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}(t[0],t[t.length-1])||t.push(t[0]),t}function m(t){for(var e,i=0,s=0,n=t.length,r=t[s];s<n-1;s++)i+=((e=t[s+1])[0]-r[0])*(e[1]+r[1]),r=e;return i>=0}function g(t,e,i,s){var n=(s[0]-i[0])*(t[1]-i[1])-(s[1]-i[1])*(t[0]-i[0]),r=(e[0]-t[0])*(t[1]-i[1])-(e[1]-t[1])*(t[0]-i[0]),o=(s[1]-i[1])*(e[0]-t[0])-(s[0]-i[0])*(e[1]-t[1]);if(0!==o){var a=n/o,l=r/o;if(a>=0&&a<=1&&l>=0&&l<=1)return!0}return!1}function y(t,e){for(var i=0;i<t.length-1;i++)for(var s=0;s<e.length-1;s++)if(g(t[i],t[i+1],e[s],e[s+1]))return!0;return!1}function v(t,e){var i=y(t,e),s=function(t,e){for(var i=!1,s=-1,n=t.length,r=n-1;++s<n;r=s)(t[s][1]<=e[1]&&e[1]<t[r][1]||t[r][1]<=e[1]&&e[1]<t[s][1])&&e[0]<(t[r][0]-t[s][0])*(e[1]-t[s][1])/(t[r][1]-t[s][1])+t[s][0]&&(i=!i);return i}(t,e[0]);return!(i||!s)}function _(t){var e=[],i=t.slice(0),s=f(i.shift().slice(0));if(s.length>=4){m(s)||s.reverse(),e.push(s);for(var n=0;n<i.length;n++){var r=f(i[n].slice(0));r.length>=4&&(m(r)&&r.reverse(),e.push(r))}}return e}function b(t){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e}function L(t,e){var i={};if(t.features){i.type="FeatureCollection",i.features=[];for(var s=0;s<t.features.length;s++)i.features.push(L(t.features[s],e))}if("number"==typeof t.x&&"number"==typeof t.y&&(i.type="Point",i.coordinates=[t.x,t.y],"number"==typeof t.z&&i.coordinates.push(t.z)),t.points&&(i.type="MultiPoint",i.coordinates=t.points.slice(0)),t.paths&&(1===t.paths.length?(i.type="LineString",i.coordinates=t.paths[0].slice(0)):(i.type="MultiLineString",i.coordinates=t.paths.slice(0))),t.rings&&(i=function(t){for(var e,i,s=[],n=[],r=0;r<t.length;r++){var o=f(t[r].slice(0));if(!(o.length<4))if(m(o)){var a=[o.slice().reverse()];s.push(a)}else n.push(o.slice().reverse())}for(var l=[];n.length;){i=n.pop();var u=!1;for(e=s.length-1;e>=0;e--)if(v(s[e][0],i)){s[e].push(i),u=!0;break}u||l.push(i)}for(;l.length;){i=l.pop();var h=!1;for(e=s.length-1;e>=0;e--)if(y(s[e][0],i)){s[e].push(i),h=!0;break}h||s.push([i.reverse()])}return 1===s.length?{type:"Polygon",coordinates:s[0]}:{type:"MultiPolygon",coordinates:s}}(t.rings.slice(0))),"number"==typeof t.xmin&&"number"==typeof t.ymin&&"number"==typeof t.xmax&&"number"==typeof t.ymax&&(i.type="Polygon",i.coordinates=[[[t.xmax,t.ymax],[t.xmin,t.ymax],[t.xmin,t.ymin],[t.xmax,t.ymin],[t.xmax,t.ymax]]]),(t.geometry||t.attributes)&&(i.type="Feature",i.geometry=t.geometry?L(t.geometry):null,i.properties=t.attributes?b(t.attributes):null,t.attributes))try{i.id=function(t,e){for(var i=e?[e,"OBJECTID","FID"]:["OBJECTID","FID"],s=0;s<i.length;s++){var n=i[s];if(n in t&&("string"==typeof t[n]||"number"==typeof t[n]))return t[n]}throw Error("No valid id attribute found")}(t.attributes,e)}catch(t){}return JSON.stringify(i.geometry)===JSON.stringify({})&&(i.geometry=null),t.spatialReference&&t.spatialReference.wkid&&4326!==t.spatialReference.wkid&&console.warn("Object converted in non-standard crs - "+JSON.stringify(t.spatialReference)),i}function x(t,e){e=e||"OBJECTID";var i,s={wkid:4326},n={};switch(t.type){case"Point":n.x=t.coordinates[0],n.y=t.coordinates[1],n.spatialReference=s;break;case"MultiPoint":n.points=t.coordinates.slice(0),n.spatialReference=s;break;case"LineString":n.paths=[t.coordinates.slice(0)],n.spatialReference=s;break;case"MultiLineString":n.paths=t.coordinates.slice(0),n.spatialReference=s;break;case"Polygon":n.rings=_(t.coordinates.slice(0)),n.spatialReference=s;break;case"MultiPolygon":n.rings=function(t){for(var e=[],i=0;i<t.length;i++)for(var s=_(t[i]),n=s.length-1;n>=0;n--){var r=s[n].slice(0);e.push(r)}return e}(t.coordinates.slice(0)),n.spatialReference=s;break;case"Feature":t.geometry&&(n.geometry=x(t.geometry,e)),n.attributes=t.properties?b(t.properties):{},t.id&&(n.attributes[e]=t.id);break;case"FeatureCollection":for(n=[],i=0;i<t.features.length;i++)n.push(x(t.features[i],e));break;case"GeometryCollection":for(n=[],i=0;i<t.geometries.length;i++)n.push(x(t.geometries[i],e))}return n}const S=(t,e)=>(180*Math.atan2(e.y-t.y,e.x-t.x)/Math.PI+90+360)%360,w=(t,e)=>e.map(e=>t.project(e));function T(t,e){return x(t,e)}function I(t,e){return L(t,e)}function A(t){if("NaN"!==t.xmin&&"NaN"!==t.ymin&&"NaN"!==t.xmax&&"NaN"!==t.ymax){var i=e.latLng(t.ymin,t.xmin),s=e.latLng(t.ymax,t.xmax);return e.latLngBounds(i,s)}return null}function C(t){return{xmin:(t=e.latLngBounds(t)).getSouthWest().lng,ymin:t.getSouthWest().lat,xmax:t.getNorthEast().lng,ymax:t.getNorthEast().lat,spatialReference:{wkid:4326}}}var k=/^(OBJECTID|FID|OID|ID)$/i;function O(t){var e;if(t.objectIdFieldName)e=t.objectIdFieldName;else if(t.fields){for(var i=0;i<=t.fields.length-1;i++)if("esriFieldTypeOID"===t.fields[i].type){e=t.fields[i].name;break}if(!e)for(i=0;i<=t.fields.length-1;i++)if(t.fields[i].name.match(k)){e=t.fields[i].name;break}}return e}function P(t){for(var e in t.attributes)if(e.match(k))return e}function R(t,e){var i,s=t.features||t.results,n=s.length;i=e||O(t);var r={type:"FeatureCollection",features:[]};if(n)for(var o=s.length-1;o>=0;o--){var a=I(s[o],i||P(s[o]));r.features.push(a)}return r}function E(t){return"/"!==(t=e.Util.trim(t))[t.length-1]&&(t+="/"),t}function F(t){if(-1!==t.url.indexOf("?")){t.requestParams=t.requestParams||{};var e=t.url.substring(t.url.indexOf("?")+1);t.url=t.url.split("?")[0],t.requestParams=JSON.parse('{"'+decodeURI(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')}return t.url=E(t.url.split("?")[0]),t}function M(t){return/^(?!.*utility\.arcgis\.com).*\.arcgis\.com.*FeatureServer/i.test(t)}function N(t){var e;switch(t){case"Point":e="esriGeometryPoint";break;case"MultiPoint":e="esriGeometryMultipoint";break;case"LineString":case"MultiLineString":e="esriGeometryPolyline";break;case"Polygon":case"MultiPolygon":e="esriGeometryPolygon"}return e}function z(){console&&console.warn&&console.warn.apply(console,arguments)}function D(t){return t.getSize().x-n.attributionWidthOffset+"px"}function q(t){if(t.attributionControl&&!t.attributionControl._esriAttributionAdded){t.attributionControl.setPrefix('<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | Powered by <a href="https://www.esri.com">Esri</a>');var i=document.createElement("style");i.type="text/css",i.innerHTML=".esri-truncated-attribution:hover {white-space: normal;}",document.getElementsByTagName("head")[0].appendChild(i),e.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution:hover");var s=document.createElement("style");s.type="text/css",s.innerHTML=".esri-truncated-attribution {vertical-align: -3px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;transition: 0s white-space;transition-delay: 1s;max-width: "+D(t)+";}",document.getElementsByTagName("head")[0].appendChild(s),e.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution"),t.on("resize",function(e){t.attributionControl._container.style.maxWidth=D(e.target)}),t.on("unload",function(){i.parentNode.removeChild(i),s.parentNode.removeChild(s);for(var t=document.querySelectorAll(".esri-leaflet-jsonp"),e=0;e<t.length;e++)t.item(e).parentNode.removeChild(t.item(e))}),t.attributionControl._esriAttributionAdded=!0}}function B(t){var i={geometry:null,geometryType:null};return t instanceof e.LatLngBounds?(i.geometry=C(t),i.geometryType="esriGeometryEnvelope",i):(t.getLatLng&&(t=t.getLatLng()),t instanceof e.LatLng&&(t={type:"Point",coordinates:[t.lng,t.lat]}),t instanceof e.GeoJSON&&(t=t.getLayers()[0].feature.geometry,i.geometry=T(t),i.geometryType=N(t.type)),t.toGeoJSON&&(t=t.toGeoJSON()),"Feature"===t.type&&(t=t.geometry),"Point"===t.type||"LineString"===t.type||"Polygon"===t.type||"MultiPolygon"===t.type?(i.geometry=T(t),i.geometryType=N(t.type),i):void z("invalid geometry passed to spatial query. Should be L.LatLng, L.LatLngBounds, L.Marker or a GeoJSON Point, Line, Polygon or MultiPolygon object"))}function U(t,i){c(t,{},e.Util.bind(function(t,s){if(!t){i._esriAttributions=[];for(var n=0;n<s.contributors.length;n++)for(var r=s.contributors[n],o=0;o<r.coverageAreas.length;o++){var a=r.coverageAreas[o],l=e.latLng(a.bbox[0],a.bbox[1]),u=e.latLng(a.bbox[2],a.bbox[3]);i._esriAttributions.push({attribution:r.attribution,score:a.score,bounds:e.latLngBounds(l,u),minZoom:a.zoomMin,maxZoom:a.zoomMax})}i._esriAttributions.sort(function(t,e){return e.score-t.score}),j({target:i})}},this))}function j(t){var i=t.target,s=i._esriAttributions;if(i&&i.attributionControl){var n=i.attributionControl._container.querySelector(".esri-dynamic-attribution");if(n&&s){for(var r="",o=i.getBounds(),a=e.latLngBounds(o.getSouthWest().wrap(),o.getNorthEast().wrap()),l=i.getZoom(),u=0;u<s.length;u++){var h=s[u],c=h.attribution;!r.match(c)&&h.bounds.intersects(a)&&l>=h.minZoom&&l<=h.maxZoom&&(r+=", "+c)}r=r.substr(2),n.innerHTML=r,n.style.maxWidth=D(i),i.fire("attributionupdated",{attribution:r})}}}var G={warn:z,cleanUrl:E,getUrlParams:F,isArcgisOnline:M,geojsonTypeToArcGIS:N,responseToFeatureCollection:R,geojsonToArcGIS:T,arcgisToGeoJSON:I,boundsToExtent:C,extentToBounds:A,calcAttributionWidth:D,setEsriAttribution:q,_setGeometry:B,_getAttributionData:U,_updateMapAttribution:j,_findIdAttributeFromFeature:P,_findIdAttributeFromResponse:O,computeSegmentHeading:S,getDirectionPoints:w},H=e.Class.extend({options:{proxy:!1,useCors:i},generateSetter:function(t,i){return e.Util.bind(function(e){return this.params[t]=e,this},i)},initialize:function(t){if(t.request&&t.options?(this._service=t,e.Util.setOptions(this,t.options)):(e.Util.setOptions(this,t),this.options.url=E(t.url)),this.params=e.Util.extend({},this.params||{}),this.setters)for(var i in this.setters){var s=this.setters[i];this[i]=this.generateSetter(s,this)}},token:function(t){return this._service?this._service.authenticate(t):this.params.token=t,this},format:function(t){return this.params.returnUnformattedValues=!t,this},request:function(t,i){return this.options.requestParams&&e.Util.extend(this.params,this.options.requestParams),this._service?this._service.request(this.path,this.params,t,i):this._request("request",this.path,this.params,t,i)},_request:function(t,e,i,s,n){var r=this.options.proxy?this.options.proxy+"?"+this.options.url+e:this.options.url+e;return"get"!==t&&"request"!==t||this.options.useCors?d[t](r,i,s,n):d.get.JSONP(r,i,s,n)}});var Z=H.extend({setters:{offset:"resultOffset",limit:"resultRecordCount",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",returnM:"returnM",transform:"datumTransformation",token:"token"},path:"query",params:{returnGeometry:!0,where:"1=1",outSr:4326,outFields:"*"},within:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelContains",this},intersects:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelIntersects",this},contains:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelWithin",this},crosses:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelCrosses",this},touches:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelTouches",this},overlaps:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelOverlaps",this},bboxIntersects:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelEnvelopeIntersects",this},indexIntersects:function(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelIndexIntersects",this},nearby:function(t,i){return t=e.latLng(t),this.params.geometry=[t.lng,t.lat],this.params.geometryType="esriGeometryPoint",this.params.spatialRel="esriSpatialRelIntersects",this.params.units="esriSRUnit_Meter",this.params.distance=i,this.params.inSr=4326,this},where:function(t){return this.params.where=t,this},between:function(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},orderBy:function(t,e){return e=e||"ASC",this.params.orderByFields=this.params.orderByFields?this.params.orderByFields+",":"",this.params.orderByFields+=[t,e].join(" "),this},run:function(t,e){return this._cleanParams(),this.options.isModern||M(this.options.url)?(this.params.f="geojson",this.request(function(i,s){this._trapSQLerrors(i),t.call(e,i,s,s)},this)):this.request(function(i,s){this._trapSQLerrors(i),t.call(e,i,s&&R(s),s)},this)},count:function(t,e){return this._cleanParams(),this.params.returnCountOnly=!0,this.request(function(e,i){t.call(this,e,i&&i.count,i)},e)},ids:function(t,e){return this._cleanParams(),this.params.returnIdsOnly=!0,this.request(function(e,i){t.call(this,e,i&&i.objectIds,i)},e)},bounds:function(t,e){return this._cleanParams(),this.params.returnExtentOnly=!0,this.request(function(i,s){s&&s.extent&&A(s.extent)?t.call(e,i,A(s.extent),s):(i={message:"Invalid Bounds"},t.call(e,i,null,s))},e)},distinct:function(){return this.params.returnGeometry=!1,this.params.returnDistinctValues=!0,this},pixelSize:function(t){var i=e.point(t);return this.params.pixelSize=[i.x,i.y],this},layer:function(t){return this.path=t+"/query",this},_trapSQLerrors:function(t){t&&"400"===t.code&&z("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")},_cleanParams:function(){delete this.params.returnIdsOnly,delete this.params.returnExtentOnly,delete this.params.returnCountOnly},_setGeometryParams:function(t){this.params.inSr=4326;var e=B(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}});function J(t){return new Z(t)}var V=H.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1},layerDefs:function(t,e){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[t,e].join(":"),this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run:function(t,e){return this.request(function(i,s){t.call(e,i,s&&R(s),s)},e)}});function W(t){return new V(t)}var Q=H.extend({path:"identify",between:function(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this}});var K=Q.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,layers:"all",tolerance:3,returnGeometry:!0},on:function(t){var e=C(t.getBounds()),i=t.getSize();return this.params.imageDisplay=[i.x,i.y,96],this.params.mapExtent=[e.xmin,e.ymin,e.xmax,e.ymax],this},at:function(t){return 2===t.length&&(t=e.latLng(t)),this._setGeometryParams(t),this},layerDef:function(t,e){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[t,e].join(":"),this},simplify:function(t,e){var i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run:function(t,e){return this.request(function(i,s){if(i)t.call(e,i,void 0,s);else{var n=R(s);s.results=s.results.reverse();for(var r=0;r<n.features.length;r++){n.features[r].layerId=s.results[r].layerId}t.call(e,void 0,n,s)}})},_setGeometryParams:function(t){var e=B(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}});function X(t){return new K(t)}var $=Q.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:!1},at:function(t){return t=e.latLng(t),this.params.geometry=JSON.stringify({x:t.lng,y:t.lat,spatialReference:{wkid:4326}}),this.params.geometryType="esriGeometryPoint",this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(t,e){return this.request(function(i,s){t.call(e,i,s&&this._responseToGeoJSON(s),s)},this)},_responseToGeoJSON:function(t){var e=t.location,i=t.catalogItems,s=t.catalogItemVisibilities,n={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[e.x,e.y]},crs:{type:"EPSG",properties:{code:e.spatialReference.wkid}},properties:{OBJECTID:t.objectId,name:t.name,value:t.value},id:t.objectId}};if(t.properties&&t.properties.Values&&(n.pixel.properties.values=t.properties.Values),i&&i.features&&(n.catalogItems=R(i),s&&s.length===n.catalogItems.features.length))for(var r=s.length-1;r>=0;r--)n.catalogItems.features[r].properties.catalogItemVisibility=s[r];return n}});function Y(t){return new $(t)}var tt=e.Evented.extend({options:{proxy:!1,useCors:i,timeout:0},initialize:function(t){t=t||{},this._requestQueue=[],this._authenticating=!1,e.Util.setOptions(this,t),this.options.url=E(this.options.url)},get:function(t,e,i,s){return this._request("get",t,e,i,s)},post:function(t,e,i,s){return this._request("post",t,e,i,s)},request:function(t,e,i,s){return this._request("request",t,e,i,s)},metadata:function(t,e){return this._request("get","",{},t,e)},authenticate:function(t){return this._authenticating=!1,this.options.token=t,this._runQueue(),this},getTimeout:function(){return this.options.timeout},setTimeout:function(t){this.options.timeout=t},_request:function(t,i,s,n,r){this.fire("requeststart",{url:this.options.url+i,params:s,method:t},!0);var o=this._createServiceCallback(t,i,s,n,r);if(this.options.token&&(s.token=this.options.token),this.options.requestParams&&e.Util.extend(s,this.options.requestParams),!this._authenticating){var a=this.options.proxy?this.options.proxy+"?"+this.options.url+i:this.options.url+i;return"get"!==t&&"request"!==t||this.options.useCors?d[t](a,s,o,r):d.get.JSONP(a,s,o,r)}this._requestQueue.push([t,i,s,n,r])},_createServiceCallback:function(t,i,s,n,r){return e.Util.bind(function(o,a){!o||499!==o.code&&498!==o.code||(this._authenticating=!0,this._requestQueue.push([t,i,s,n,r]),this.fire("authenticationrequired",{authenticate:e.Util.bind(this.authenticate,this)},!0),o.authenticate=e.Util.bind(this.authenticate,this)),n.call(r,o,a),o?this.fire("requesterror",{url:this.options.url+i,params:s,message:o.message,code:o.code,method:t},!0):this.fire("requestsuccess",{url:this.options.url+i,params:s,response:a,method:t},!0),this.fire("requestend",{url:this.options.url+i,params:s,method:t},!0)},this)},_runQueue:function(){for(var t=this._requestQueue.length-1;t>=0;t--){var e=this._requestQueue[t];this[e.shift()].apply(this,e)}this._requestQueue=[]}});var et=tt.extend({identify:function(){return X(this)},find:function(){return W(this)},query:function(){return J(this)}});function it(t){return new et(t)}var st=tt.extend({query:function(){return J(this)},identify:function(){return Y(this)}});function nt(t){return new st(t)}var rt=tt.extend({options:{idAttribute:"OBJECTID"},query:function(){return J(this)},addFeature:function(t,e,i){this.addFeatures(t,e,i)},addFeatures:function(t,e,i){for(var s=t.features?t.features:[t],n=s.length-1;n>=0;n--)delete s[n].id;return t=T(t),t=s.length>1?t:[t],this.post("addFeatures",{features:t},function(t,s){var n=s&&s.addResults?s.addResults.length>1?s.addResults:s.addResults[0]:void 0;e&&e.call(i,t||s.addResults[0].error,n)},i)},updateFeature:function(t,e,i){this.updateFeatures(t,e,i)},updateFeatures:function(t,e,i){var s=t.features?t.features:[t];return t=T(t,this.options.idAttribute),t=s.length>1?t:[t],this.post("updateFeatures",{features:t},function(t,s){var n=s&&s.updateResults?s.updateResults.length>1?s.updateResults:s.updateResults[0]:void 0;e&&e.call(i,t||s.updateResults[0].error,n)},i)},deleteFeature:function(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures:function(t,e,i){return this.post("deleteFeatures",{objectIds:t},function(t,s){var n=s&&s.deleteResults?s.deleteResults.length>1?s.deleteResults:s.deleteResults[0]:void 0;e&&e.call(i,t||s.deleteResults[0].error,n)},i)}});function ot(t){return new rt(t)}var at="https:"!==window.location.protocol?"http:":"https:",lt=e.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:at+"//{s}.tile.osm.org/{z}/{x}/{y}.png",options:{minZoom:1,maxZoom:19,subdomains:["c"],attribution:"OpenStreetMap"}},NationalGeographic:{urlTemplate:at+"//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"National Geographic, DeLorme, HERE, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, increment P Corp."}},DarkGray:{urlTemplate:at+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors"}}}},initialize:function(t,i){var s;if("object"==typeof t&&t.urlTemplate&&t.options)s=t;else{if("string"!=typeof t||!lt.TILES[t])throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Physical", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ImageryClarity", "ImageryFirefly", ShadedRelief", "ShadedReliefLabels", "Terrain", "TerrainLabels" or "USATopo"');s=lt.TILES[t]}var n=e.Util.extend(s.options,i);e.Util.setOptions(this,n),this.options.token&&-1===s.urlTemplate.indexOf("token=")&&(s.urlTemplate+="?token="+this.options.token),e.TileLayer.prototype.initialize.call(this,s.urlTemplate,n)},onAdd:function(t){!function(t){if(t.attributionControl&&!t.attributionControl._esriAttributionAdded){t.attributionControl.setPrefix('<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | Powered by <a href="https://enouvo.com">Enouvo</a>');var i=document.createElement("style");i.type="text/css",i.innerHTML=".esri-truncated-attribution:hover {white-space: normal;}",document.getElementsByTagName("head")[0].appendChild(i),e.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution:hover");var s=document.createElement("style");s.type="text/css",s.innerHTML=".esri-truncated-attribution {vertical-align: -3px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;transition: 0s white-space;transition-delay: 1s;max-width: "+D(t)+";}",document.getElementsByTagName("head")[0].appendChild(s),e.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution"),t.on("resize",function(e){t.attributionControl._container.style.maxWidth=D(e.target)}),t.on("unload",function(){i.parentNode.removeChild(i),s.parentNode.removeChild(s);for(var t=document.querySelectorAll(".esri-leaflet-jsonp"),e=0;e<t.length;e++)t.item(e).parentNode.removeChild(t.item(e))}),t.attributionControl._esriAttributionAdded=!0}}(t),"esri-labels"===this.options.pane&&this._initPane(),this.options.attributionUrl&&U(this.options.attributionUrl,t),t.on("moveend",j),e.TileLayer.prototype.onAdd.call(this,t)},onRemove:function(t){t.off("moveend",j),e.TileLayer.prototype.onRemove.call(this,t)},_initPane:function(){if(!this._map.getPane(this.options.pane)){var t=this._map.createPane(this.options.pane);t.style.pointerEvents="none",t.style.zIndex=500}},getAttribution:function(){if(this.options.attribution)var t='<span class="esri-dynamic-attribution">'+this.options.attribution+"</span>";return t}});function ut(t,e){return new lt(t,e)}var ht=e.TileLayer.extend({options:{zoomOffsetAllowance:.1,errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAA1BMVEUzNDVszlHHAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAAAAAAAAAB6mUWpAAAADZJREFUeJztwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7waBAAABw08RwAAAAABJRU5ErkJggg=="},statics:{MercatorZoomLevels:{0:156543.033928,1:78271.5169639999,2:39135.7584820001,3:19567.8792409999,4:9783.93962049996,5:4891.96981024998,6:2445.98490512499,7:1222.99245256249,8:611.49622628138,9:305.748113140558,10:152.874056570411,11:76.4370282850732,12:38.2185141425366,13:19.1092570712683,14:9.55462853563415,15:4.77731426794937,16:2.38865713397468,17:1.19432856685505,18:.597164283559817,19:.298582141647617,20:.14929107082381,21:.07464553541191,22:.0373227677059525,23:.0186613838529763}},initialize:function(t){t=F(t=e.Util.setOptions(this,t)),this.tileUrl=(t.proxy?t.proxy+"?":"")+t.url+"tile/{z}/{y}/{x}"+(t.requestParams&&Object.keys(t.requestParams).length>0?e.Util.getParamString(t.requestParams):""),-1!==t.url.indexOf("{s}")&&t.subdomains&&(t.url=t.url.replace("{s}",t.subdomains[0])),this.service=it(t),this.service.addEventParent(this),new RegExp(/tiles.arcgis(online)?\.com/g).test(t.url)&&(this.tileUrl=this.tileUrl.replace("://tiles","://tiles{s}"),t.subdomains=["1","2","3","4"]),this.options.token&&(this.tileUrl+="?token="+this.options.token),e.TileLayer.prototype.initialize.call(this,this.tileUrl,t)},getTileUrl:function(t){var i=this._getZoomForUrl();return e.Util.template(this.tileUrl,e.Util.extend({s:this._getSubdomain(t),x:t.x,y:t.y,z:this._lodMap&&this._lodMap[i]?this._lodMap[i]:i},this.options))},createTile:function(t,i){var s=document.createElement("img");return e.DomEvent.on(s,"load",e.Util.bind(this._tileOnLoad,this,i,s)),e.DomEvent.on(s,"error",e.Util.bind(this._tileOnError,this,i,s)),this.options.crossOrigin&&(s.crossOrigin=""),s.alt="",!this._lodMap||this._lodMap&&this._lodMap[this._getZoomForUrl()]?s.src=this.getTileUrl(t):this.once("lodmap",function(){s.src=this.getTileUrl(t)},this),s},onAdd:function(t){q(t),this._lodMap||this.metadata(function(i,s){if(!i&&s.spatialReference){var n=s.spatialReference.latestWkid||s.spatialReference.wkid;if(!this.options.attribution&&t.attributionControl&&s.copyrightText&&(this.options.attribution=s.copyrightText,t.attributionControl.addAttribution(this.getAttribution())),t.options.crs!==e.CRS.EPSG3857||102100!==n&&3857!==n)t.options.crs&&t.options.crs.code&&t.options.crs.code.indexOf(n)>-1||z("L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet http://esri.github.io/esri-leaflet/examples/non-mercator-projection.html");else{this._lodMap={};for(var r=s.tileInfo.lods,o=ht.MercatorZoomLevels,a=0;a<r.length;a++){var l=r[a];for(var u in o){var h=o[u];if(this._withinPercentage(l.resolution,h,this.options.zoomOffsetAllowance)){this._lodMap[u]=l.level;break}}}this.fire("lodmap")}}},this),e.TileLayer.prototype.onAdd.call(this,t)},metadata:function(t,e){return this.service.metadata(t,e),this},identify:function(){return this.service.identify()},find:function(){return this.service.find()},query:function(){return this.service.query()},authenticate:function(t){var e="?token="+t;return this.tileUrl=this.options.token?this.tileUrl.replace(/\?token=(.+)/g,e):this.tileUrl+e,this.options.token=t,this.service.authenticate(t),this},_withinPercentage:function(t,e,i){return Math.abs(t/e-1)<i}});var ct=e.ImageOverlay.extend({onAdd:function(t){this._topLeft=t.getPixelBounds().min,e.ImageOverlay.prototype.onAdd.call(this,t)},_reset:function(){this._map.options.crs===e.CRS.EPSG3857?e.ImageOverlay.prototype._reset.call(this):e.DomUtil.setPosition(this._image,this._topLeft.subtract(this._map.getPixelOrigin()))}}),pt=e.Layer.extend({options:{opacity:1,position:"front",f:"image",useCors:i,attribution:null,interactive:!1,alt:""},onAdd:function(t){q(t),this.options.zIndex&&(this.options.position=null),this._update=e.Util.throttle(this._update,this.options.updateInterval,this),t.on("moveend",this._update,this),this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?t.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null),this._update(),this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this.metadata(function(e,i){!e&&!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))},this)},onRemove:function(t){this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.off("moveend",this._update,this)},bindPopup:function(t,i){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=e.popup(i),this._popupFunction=t,this._map&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this},unbindPopup:function(){return this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._popup=!1,this},bringToFront:function(){return this.options.position="front",this._currentImage&&(this._currentImage.bringToFront(),this._setAutoZIndex(Math.max)),this},bringToBack:function(){return this.options.position="back",this._currentImage&&(this._currentImage.bringToBack(),this._setAutoZIndex(Math.min)),this},setZIndex:function(t){return this.options.zIndex=t,this._currentImage&&this._currentImage.setZIndex(t),this},_setAutoZIndex:function(t){if(this._currentImage){for(var e,i=this._currentImage.getPane().children,s=-t(-1/0,1/0),n=0,r=i.length;n<r;n++)e=i[n].style.zIndex,i[n]!==this._currentImage._image&&e&&(s=t(s,+e));isFinite(s)&&(this.options.zIndex=s+t(-1,1),this.setZIndex(this.options.zIndex))}},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(t){return this.options.opacity=t,this._currentImage&&this._currentImage.setOpacity(t),this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,e){return this.options.from=t,this.options.to=e,this._update(),this},metadata:function(t,e){return this.service.metadata(t,e),this},authenticate:function(t){return this.service.authenticate(t),this},redraw:function(){this._update()},_renderImage:function(t,e,i){if(this._map){if(i&&(t="data:"+i+";base64,"+t),!t)return;var s=new ct(t,e,{opacity:0,crossOrigin:this.options.useCors,alt:this.options.alt,pane:this.options.pane||this.getPane(),interactive:this.options.interactive}).addTo(this._map),n=function(t){if(s.off("error",n,this),this._map){var i=t.target,r=this._currentImage;i._bounds.equals(e)&&i._bounds.equals(this._map.getBounds())?(this._currentImage=i,"front"===this.options.position?this.bringToFront():"back"===this.options.position&&this.bringToBack(),this.options.zIndex&&this.setZIndex(this.options.zIndex),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage),r&&this._map&&this._map.removeLayer(r),r&&r._map&&r._map.removeLayer(r)):this._map.removeLayer(i)}this.fire("load",{bounds:e})};s.once("error",function(){this._map.removeLayer(s),this.fire("error"),s.off("load",n,this)},this),s.once("load",n,this),this.fire("loading",{bounds:e})}},_update:function(){if(this._map){var t=this._map.getZoom(),i=this._map.getBounds();if(!(this._animatingZoom||this._map._panTransition&&this._map._panTransition._inProgress))if(t>this.options.maxZoom||t<this.options.minZoom)this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null);else{var s=this._buildExportParams();e.Util.extend(s,this.options.requestParams),s?this._requestExport(s,i):this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null)}}},_renderPopup:function(t,i,s,n){if(t=e.latLng(t),this._shouldRenderPopup&&this._lastClick.equals(t)){var r=this._popupFunction(i,s,n);r&&this._popup.setLatLng(t).setContent(r).openOn(this._map)}},_resetPopupState:function(t){this._shouldRenderPopup=!1,this._lastClick=t.latlng},_calculateBbox:function(){var t=this._map.getPixelBounds(),i=this._map.unproject(t.getBottomLeft()),s=this._map.unproject(t.getTopRight()),n=this._map.options.crs.project(s),r=this._map.options.crs.project(i),o=e.bounds(n,r);return[o.getBottomLeft().x,o.getBottomLeft().y,o.getTopRight().x,o.getTopRight().y].join(",")},_calculateImageSize:function(){var t=this._map.getPixelBounds(),e=this._map.getSize(),i=this._map.unproject(t.getBottomLeft()),s=this._map.unproject(t.getTopRight()),n=this._map.latLngToLayerPoint(s).y,r=this._map.latLngToLayerPoint(i).y;return(n>0||r<e.y)&&(e.y=r-n),e.x+","+e.y}}),dt=pt.extend({options:{updateInterval:150,format:"jpgpng",transparent:!0,f:"image"},query:function(){return this.service.query()},identify:function(){return this.service.identify()},initialize:function(t){t=F(t),this.service=nt(t),this.service.addEventParent(this),e.Util.setOptions(this,t)},setPixelType:function(t){return this.options.pixelType=t,this._update(),this},getPixelType:function(){return this.options.pixelType},setBandIds:function(t){return e.Util.isArray(t)?this.options.bandIds=t.join(","):this.options.bandIds=t.toString(),this._update(),this},getBandIds:function(){return this.options.bandIds},setNoData:function(t,i){return e.Util.isArray(t)?this.options.noData=t.join(","):this.options.noData=t.toString(),i&&(this.options.noDataInterpretation=i),this._update(),this},getNoData:function(){return this.options.noData},getNoDataInterpretation:function(){return this.options.noDataInterpretation},setRenderingRule:function(t){this.options.renderingRule=t,this._update()},getRenderingRule:function(){return this.options.renderingRule},setMosaicRule:function(t){this.options.mosaicRule=t,this._update()},getMosaicRule:function(){return this.options.mosaicRule},_getPopupData:function(t){var i=e.Util.bind(function(i,s,n){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,n)},this),300)},this),s=this.identify().at(t.latlng);this.options.mosaicRule&&s.setMosaicRule(this.options.mosaicRule),s.run(i),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams:function(){var t=parseInt(this._map.options.crs.code.split(":")[1],10),e={bbox:this._calculateBbox(),size:this._calculateImageSize(),format:this.options.format,transparent:this.options.transparent,bboxSR:t,imageSR:t};return this.options.from&&this.options.to&&(e.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this.options.pixelType&&(e.pixelType=this.options.pixelType),this.options.interpolation&&(e.interpolation=this.options.interpolation),this.options.compressionQuality&&(e.compressionQuality=this.options.compressionQuality),this.options.bandIds&&(e.bandIds=this.options.bandIds),(0===this.options.noData||this.options.noData)&&(e.noData=this.options.noData),this.options.noDataInterpretation&&(e.noDataInterpretation=this.options.noDataInterpretation),this.service.options.token&&(e.token=this.service.options.token),this.options.renderingRule&&(e.renderingRule=JSON.stringify(this.options.renderingRule)),this.options.mosaicRule&&(e.mosaicRule=JSON.stringify(this.options.mosaicRule)),e},_requestExport:function(t,i){"json"===this.options.f?this.service.request("exportImage",t,function(t,e){t||(this.options.token&&(e.href+="?token="+this.options.token),this.options.proxy&&(e.href=this.options.proxy+"?"+e.href),this._renderImage(e.href,i))},this):(t.f="image",this._renderImage(this.options.url+"exportImage"+e.Util.getParamString(t),i))}});var ft=pt.extend({options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png24",transparent:!0,f:"json"},initialize:function(t){t=F(t),this.service=it(t),this.service.addEventParent(this),(t.proxy||t.token)&&"json"!==t.f&&(t.f="json"),e.Util.setOptions(this,t)},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(t){return this.options.dynamicLayers=t,this._update(),this},getLayers:function(){return this.options.layers},setLayers:function(t){return this.options.layers=t,this._update(),this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(t){return this.options.layerDefs=t,this._update(),this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(t){return this.options.timeOptions=t,this._update(),this},query:function(){return this.service.query()},identify:function(){return this.service.identify()},find:function(){return this.service.find()},_getPopupData:function(t){var i,s=e.Util.bind(function(i,s,n){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,n)},this),300)},this);if((i=this.options.popup?this.options.popup.on(this._map).at(t.latlng):this.identify().on(this._map).at(t.latlng)).params.maxAllowableOffset||i.simplify(this._map,.5),this.options.popup&&this.options.popup.params&&this.options.popup.params.layers||(this.options.layers?i.layers("visible:"+this.options.layers.join(",")):i.layers("visible")),this.options.layerDefs&&"string"!=typeof this.options.layerDefs&&!i.params.layerDefs)for(var n in this.options.layerDefs)this.options.layerDefs.hasOwnProperty(n)&&i.layerDef(n,this.options.layerDefs[n]);i.run(s),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams:function(){var t=parseInt(this._map.options.crs.code.split(":")[1],10),e={bbox:this._calculateBbox(),size:this._calculateImageSize(),dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:t,imageSR:t};if(this.options.dynamicLayers&&(e.dynamicLayers=this.options.dynamicLayers),this.options.layers){if(0===this.options.layers.length)return;e.layers="show:"+this.options.layers.join(",")}return this.options.layerDefs&&(e.layerDefs="string"==typeof this.options.layerDefs?this.options.layerDefs:JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(e.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(e.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this.service.options.token&&(e.token=this.service.options.token),this.options.proxy&&(e.proxy=this.options.proxy),this.options.disableCache&&(e._ts=Date.now()),e},_requestExport:function(t,i){"json"===this.options.f?this.service.request("export",t,function(t,e){t||(this.options.token&&(e.href+="?token="+this.options.token),this.options.proxy&&(e.href=this.options.proxy+"?"+e.href),e.href?this._renderImage(e.href,i):this._renderImage(e.imageData,i,e.contentType))},this):(t.f="image",this._renderImage(this.options.url+"export"+e.Util.getParamString(t),i))}});var mt=e.Layer.extend({options:{cellSize:512,updateInterval:150},initialize:function(t){t=e.setOptions(this,t),this._zooming=!1},onAdd:function(t){this._map=t,this._update=e.Util.throttle(this._update,this.options.updateInterval,this),this._reset(),this._update()},onRemove:function(){this._map.removeEventListener(this.getEvents(),this),this._removeCells()},getEvents:function(){return{moveend:this._update,zoomstart:this._zoomstart,zoomend:this._reset}},addTo:function(t){return t.addLayer(this),this},removeFrom:function(t){return t.removeLayer(this),this},_zoomstart:function(){this._zooming=!0},_reset:function(){this._removeCells(),this._cells={},this._activeCells={},this._cellsToLoad=0,this._cellsTotal=0,this._cellNumBounds=this._getCellNumBounds(),this._resetWrap(),this._zooming=!1},_resetWrap:function(){var t=this._map,e=t.options.crs;if(!e.infinite){var i=this._getCellSize();e.wrapLng&&(this._wrapLng=[Math.floor(t.project([0,e.wrapLng[0]]).x/i),Math.ceil(t.project([0,e.wrapLng[1]]).x/i)]),e.wrapLat&&(this._wrapLat=[Math.floor(t.project([e.wrapLat[0],0]).y/i),Math.ceil(t.project([e.wrapLat[1],0]).y/i)])}},_getCellSize:function(){return this.options.cellSize},_update:function(){if(this._map){var t=this._map.getPixelBounds(),i=this._getCellSize(),s=e.bounds(t.min.divideBy(i).floor(),t.max.divideBy(i).floor());this._removeOtherCells(s),this._addCells(s),this.fire("cellsupdated")}},_addCells:function(t){var i,s,n,r=[],o=t.getCenter(),a=this._map.getZoom();for(i=t.min.y;i<=t.max.y;i++)for(s=t.min.x;s<=t.max.x;s++)(n=e.point(s,i)).z=a,this._isValidCell(n)&&r.push(n);var l=r.length;if(0!==l)for(this._cellsToLoad+=l,this._cellsTotal+=l,r.sort(function(t,e){return t.distanceTo(o)-e.distanceTo(o)}),s=0;s<l;s++)this._addCell(r[s])},_isValidCell:function(t){var i=this._map.options.crs;if(!i.infinite){var s=this._cellNumBounds;if(!s)return!1;if(!i.wrapLng&&(t.x<s.min.x||t.x>s.max.x)||!i.wrapLat&&(t.y<s.min.y||t.y>s.max.y))return!1}if(!this.options.bounds)return!0;var n=this._cellCoordsToBounds(t);return e.latLngBounds(this.options.bounds).intersects(n)},_cellCoordsToBounds:function(t){var i=this._map,s=this.options.cellSize,n=t.multiplyBy(s),r=n.add([s,s]),o=i.wrapLatLng(i.unproject(n,t.z)),a=i.wrapLatLng(i.unproject(r,t.z));return e.latLngBounds(o,a)},_cellCoordsToKey:function(t){return t.x+":"+t.y},_keyToCellCoords:function(t){var i=t.split(":"),s=parseInt(i[0],10),n=parseInt(i[1],10);return e.point(s,n)},_removeOtherCells:function(t){for(var e in this._cells)t.contains(this._keyToCellCoords(e))||this._removeCell(e)},_removeCell:function(t){var e=this._activeCells[t];e&&(delete this._activeCells[t],this.cellLeave&&this.cellLeave(e.bounds,e.coords),this.fire("cellleave",{bounds:e.bounds,coords:e.coords}))},_removeCells:function(){for(var t in this._cells){var e=this._cells[t].bounds,i=this._cells[t].coords;this.cellLeave&&this.cellLeave(e,i),this.fire("cellleave",{bounds:e,coords:i})}},_addCell:function(t){this._wrapCoords(t);var e=this._cellCoordsToKey(t),i=this._cells[e];i&&!this._activeCells[e]&&(this.cellEnter&&this.cellEnter(i.bounds,t),this.fire("cellenter",{bounds:i.bounds,coords:t}),this._activeCells[e]=i),i||(i={coords:t,bounds:this._cellCoordsToBounds(t)},this._cells[e]=i,this._activeCells[e]=i,this.createCell&&this.createCell(i.bounds,t),this.fire("cellcreate",{bounds:i.bounds,coords:t}))},_wrapCoords:function(t){t.x=this._wrapLng?e.Util.wrapNum(t.x,this._wrapLng):t.x,t.y=this._wrapLat?e.Util.wrapNum(t.y,this._wrapLat):t.y},_getCellNumBounds:function(){var t=this._map.getPixelWorldBounds(),i=this._getCellSize();return t?e.bounds(t.min.divideBy(i).floor(),t.max.divideBy(i).ceil().subtract([1,1])):null}}),gt=mt.extend({options:{attribution:null,where:"1=1",fields:["*"],from:!1,to:!1,timeField:!1,timeFilterMode:"server",simplifyFactor:0,precision:6},initialize:function(t){if(mt.prototype.initialize.call(this,t),t&&"string"==typeof t.url&&(t=F(t)),t&&(t=e.Util.setOptions(this,t),this.service=ot(t),this.service.addEventParent(this)),"*"!==this.options.fields[0]){for(var i=!1,s=0;s<this.options.fields.length;s++)this.options.fields[s].match(/^(OBJECTID|FID|OID|ID)$/i)&&(i=!0);!1===i&&z("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}this._cache={},this._currentSnapshot=[],this._activeRequests=0},onAdd:function(t){return q(t),this.service&&this.service.metadata(function(e,i){if(!e){var s=i.supportedQueryFormats,n=!1;!1===this.service.options.isModern&&(n=!0),!n&&s&&-1!==s.indexOf("geoJSON")&&(this.service.options.isModern=!0),i.objectIdField&&(this.service.options.idAttribute=i.objectIdField),!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))}},this),t.on("zoomend",this._handleZoomChange,this),mt.prototype.onAdd.call(this,t)},onRemove:function(t){return t.off("zoomend",this._handleZoomChange,this),mt.prototype.onRemove.call(this,t)},getAttribution:function(){return this.options.attribution},createCell:function(t,e){this._visibleZoom()&&"string"==typeof this.options.url&&this._requestFeatures(t,e)},_requestFeatures:function(t,i,s){return this._activeRequests++,1===this._activeRequests&&this.fire("loading",{bounds:t},!0),this._buildQuery(t).run(function(n,r,o){o&&o.exceededTransferLimit&&this.fire("drawlimitexceeded"),!n&&r&&r.features.length&&e.Util.requestAnimFrame(e.Util.bind(function(){this._addFeatures(r.features,i),this._postProcessFeatures(t)},this)),n||!r||r.features.length||this._postProcessFeatures(t),n&&this._postProcessFeatures(t),s&&s.call(this,n,r)},this)},_postProcessFeatures:function(t){this._activeRequests--,this._activeRequests<=0&&this.fire("load",{bounds:t})},_cacheKey:function(t){return t.z+":"+t.x+":"+t.y},_addFeatures:function(t,e){var i=this._cacheKey(e);this._cache[i]=this._cache[i]||[];for(var s=t.length-1;s>=0;s--){var n=t[s].id;-1===this._currentSnapshot.indexOf(n)&&this._currentSnapshot.push(n),-1===this._cache[i].indexOf(n)&&this._cache[i].push(n)}this.options.timeField&&this._buildTimeIndexes(t),this.createLayers(t)},_buildQuery:function(t){var i=this.service.query().intersects(t).where(this.options.where).fields(this.options.fields).precision(this.options.precision);return this.options.requestParams&&e.Util.extend(i.params,this.options.requestParams),this.options.simplifyFactor&&i.simplify(this._map,this.options.simplifyFactor),"server"===this.options.timeFilterMode&&this.options.from&&this.options.to&&i.between(this.options.from,this.options.to),i},setWhere:function(t,i,s){this.options.where=t&&t.length?t:"1=1";for(var n=[],r=[],o=0,a=null,l=e.Util.bind(function(t,l){if(t&&(a=t),l)for(var u=l.features.length-1;u>=0;u--)r.push(l.features[u].id);--o<=0&&this._visibleZoom()&&(this._currentSnapshot=r,e.Util.requestAnimFrame(e.Util.bind(function(){this.removeLayers(n),this.addLayers(r),i&&i.call(s,a)},this)))},this),u=this._currentSnapshot.length-1;u>=0;u--)n.push(this._currentSnapshot[u]);for(var h in this._activeCells){o++;var c=this._keyToCellCoords(h),p=this._cellCoordsToBounds(c);this._requestFeatures(p,h,l)}return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(t,i,s,n){var r=this.options.from,o=this.options.to,a=0,l=null,u=e.Util.bind(function(e){e&&(l=e),this._filterExistingFeatures(r,o,t,i),a--,s&&a<=0&&s.call(n,l)},this);if(this.options.from=t,this.options.to=i,this._filterExistingFeatures(r,o,t,i),"server"===this.options.timeFilterMode)for(var h in this._activeCells){a++;var c=this._keyToCellCoords(h),p=this._cellCoordsToBounds(c);this._requestFeatures(p,h,u)}return this},refresh:function(){for(var t in this._activeCells){var e=this._keyToCellCoords(t),i=this._cellCoordsToBounds(e);this._requestFeatures(i,t)}this.redraw&&this.once("load",function(){this.eachFeature(function(t){this._redraw(t.feature.id)},this)},this)},_filterExistingFeatures:function(t,i,s,n){var r=t&&i?this._getFeaturesInTimeRange(t,i):this._currentSnapshot,o=this._getFeaturesInTimeRange(s,n);if(o.indexOf)for(var a=0;a<o.length;a++){var l=r.indexOf(o[a]);l>=0&&r.splice(l,1)}e.Util.requestAnimFrame(e.Util.bind(function(){this.removeLayers(r),this.addLayers(o)},this))},_getFeaturesInTimeRange:function(t,e){var i,s=[];if(this.options.timeField.start&&this.options.timeField.end){var n=this._startTimeIndex.between(t,e),r=this._endTimeIndex.between(t,e);i=n.concat(r)}else i=this._timeIndex.between(t,e);for(var o=i.length-1;o>=0;o--)s.push(i[o].id);return s},_buildTimeIndexes:function(t){var e,i;if(this.options.timeField.start&&this.options.timeField.end){var s=[],n=[];for(e=t.length-1;e>=0;e--)i=t[e],s.push({id:i.id,value:new Date(i.properties[this.options.timeField.start])}),n.push({id:i.id,value:new Date(i.properties[this.options.timeField.end])});this._startTimeIndex.bulkAdd(s),this._endTimeIndex.bulkAdd(n)}else{var r=[];for(e=t.length-1;e>=0;e--)i=t[e],r.push({id:i.id,value:new Date(i.properties[this.options.timeField])});this._timeIndex.bulkAdd(r)}},_featureWithinTimeRange:function(t){if(!this.options.from||!this.options.to)return!0;var e=+this.options.from.valueOf(),i=+this.options.to.valueOf();if("string"==typeof this.options.timeField){var s=+t.properties[this.options.timeField];return s>=e&&s<=i}if(this.options.timeField.start&&this.options.timeField.end){var n=+t.properties[this.options.timeField.start],r=+t.properties[this.options.timeField.end];return n>=e&&n<=i||r>=e&&r<=i}},_visibleZoom:function(){if(!this._map)return!1;var t=this._map.getZoom();return!(t>this.options.maxZoom||t<this.options.minZoom)},_handleZoomChange:function(){if(this._visibleZoom())for(var t in this._activeCells){var e=this._activeCells[t].coords,i=this._cacheKey(e);this._cache[i]&&this.addLayers(this._cache[i])}else this.removeLayers(this._currentSnapshot),this._currentSnapshot=[]},authenticate:function(t){return this.service.authenticate(t),this},metadata:function(t,e){return this.service.metadata(t,e),this},query:function(){return this.service.query()},_getMetadata:function(t){this._metadata?t(void 0,this._metadata):this.metadata(e.Util.bind(function(e,i){this._metadata=i,t(e,this._metadata)},this))},addFeature:function(t,e,i){this.addFeatures(t,e,i)},addFeatures:function(t,i,s){this._getMetadata(e.Util.bind(function(n,r){if(n)i&&i.call(this,n,null);else{var o=t.features?t.features:[t];this.service.addFeatures(t,e.Util.bind(function(t,e){if(!t){for(var n=o.length-1;n>=0;n--)o[n].properties[r.objectIdField]=o.length>1?e[n].objectId:e.objectId,o[n].id=o.length>1?e[n].objectId:e.objectId;this.createLayers(o)}i&&i.call(s,t,e)},this))}},this))},updateFeature:function(t,e,i){this.updateFeatures(t,e,i)},updateFeatures:function(t,e,i){var s=t.features?t.features:[t];this.service.updateFeatures(t,function(t,n){if(!t){for(var r=s.length-1;r>=0;r--)this.removeLayers([s[r].id],!0);this.createLayers(s)}e&&e.call(i,t,n)},this)},deleteFeature:function(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures:function(t,e,i){return this.service.deleteFeatures(t,function(t,s){var n=s.length?s:[s];if(!t&&n.length>0)for(var r=n.length-1;r>=0;r--)this.removeLayers([n[r].objectId],!0);e&&e.call(i,t,s)},this)}}),yt=gt.extend({options:{cacheLayers:!0},initialize:function(t){gt.prototype.initialize.call(this,t),this._originalStyle=this.options.style,this._layers={}},onRemove:function(t){for(var e in this._layers)t.removeLayer(this._layers[e]),this.fire("removefeature",{feature:this._layers[e].feature,permanent:!1},!0);return gt.prototype.onRemove.call(this,t)},createNewLayer:function(t){var i=e.GeoJSON.geometryToLayer(t,this.options);return i&&(i.defaultOptions=i.options),i},_updateLayer:function(t,i){var s=[],n=this.options.coordsToLatLng||e.GeoJSON.coordsToLatLng;switch(i.properties&&(t.feature.properties=i.properties),i.geometry.type){case"Point":s=e.GeoJSON.coordsToLatLng(i.geometry.coordinates),t.setLatLng(s);break;case"LineString":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,0,n),t.setLatLngs(s);break;case"MultiLineString":case"Polygon":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,1,n),t.setLatLngs(s);break;case"MultiPolygon":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,2,n),t.setLatLngs(s)}},createLayers:function(t){for(var e=t.length-1;e>=0;e--){var i,s=t[e],n=this._layers[s.id];this._visibleZoom()&&n&&!this._map.hasLayer(n)&&(this._map.addLayer(n),this.fire("addfeature",{feature:n.feature},!0)),n&&this.options.simplifyFactor>0&&(n.setLatLngs||n.setLatLng)&&this._updateLayer(n,s),n||((i=this.createNewLayer(s))?(i.feature=s,i.addEventParent(this),this.options.onEachFeature&&this.options.onEachFeature(i.feature,i),this._layers[i.feature.id]=i,this.setFeatureStyle(i.feature.id,this.options.style),this.fire("createfeature",{feature:i.feature},!0),this._visibleZoom()&&(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(s))&&this._map.addLayer(i)):z("invalid GeoJSON encountered"))}},addLayers:function(t){for(var e=t.length-1;e>=0;e--){var i=this._layers[t[e]];i&&this._map.addLayer(i)}},removeLayers:function(t,e){for(var i=t.length-1;i>=0;i--){var s=t[i],n=this._layers[s];n&&(this.fire("removefeature",{feature:n.feature,permanent:e},!0),this._map.removeLayer(n)),n&&e&&delete this._layers[s]}},cellEnter:function(t,i){this._visibleZoom()&&!this._zooming&&this._map&&e.Util.requestAnimFrame(e.Util.bind(function(){var t=this._cacheKey(i),e=this._cellCoordsToKey(i),s=this._cache[t];this._activeCells[e]&&s&&this.addLayers(s)},this))},cellLeave:function(t,i){this._zooming||e.Util.requestAnimFrame(e.Util.bind(function(){if(this._map){var t=this._cacheKey(i),e=this._cellCoordsToKey(i),s=this._cache[t],n=this._map.getBounds();if(!this._activeCells[e]&&s){for(var r=!0,o=0;o<s.length;o++){var a=this._layers[s[o]];a&&a.getBounds&&n.intersects(a.getBounds())&&(r=!1)}r&&this.removeLayers(s,!this.options.cacheLayers),!this.options.cacheLayers&&r&&(delete this._cache[t],delete this._cells[e],delete this._activeCells[e])}}},this))},resetStyle:function(){return this.options.style=this._originalStyle,this.eachFeature(function(t){this.resetFeatureStyle(t.feature.id)},this),this},setStyle:function(t){return this.options.style=t,this.eachFeature(function(e){this.setFeatureStyle(e.feature.id,t)},this),this},resetFeatureStyle:function(t){var i=this._layers[t],s=this._originalStyle||e.Path.prototype.options;return i&&(e.Util.extend(i.options,i.defaultOptions),this.setFeatureStyle(t,s)),this},setFeatureStyle:function(t,e){var i=this._layers[t];return"function"==typeof e&&(e=e(i.feature)),i.setStyle&&i.setStyle(e),this},eachActiveFeature:function(t,e){if(this._map){var i=this._map.getBounds();for(var s in this._layers)-1!==this._currentSnapshot.indexOf(this._layers[s].feature.id)&&("function"==typeof this._layers[s].getLatLng&&i.contains(this._layers[s].getLatLng())?t.call(e,this._layers[s]):"function"==typeof this._layers[s].getBounds&&i.intersects(this._layers[s].getBounds())&&t.call(e,this._layers[s]))}return this},eachFeature:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},getFeature:function(t){return this._layers[t]},bringToBack:function(){this.eachFeature(function(t){t.bringToBack&&t.bringToBack()})},bringToFront:function(){this.eachFeature(function(t){t.bringToFront&&t.bringToFront()})},redraw:function(t){return t&&this._redraw(t),this},_redraw:function(t){var i=this._layers[t],s=i.feature;if(i&&i.setIcon&&this.options.pointToLayer&&this.options.pointToLayer){var n=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])).options.icon;i.setIcon(n)}if(i&&i.setStyle&&this.options.pointToLayer){var r=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])).options;this.setFeatureStyle(s.id,r)}i&&i.setStyle&&this.options.style&&this.resetStyle(s.id)}});e.Map.mergeOptions({boxZoom:!1,areaSelect:!0});var vt=e.Map.BoxZoom.extend({_onMouseUp:function(t){if((1===t.which||1===t.button)&&(this._finish(),this._moved)){this._clearDeferredResetState(),this._resetStateTimeout=setTimeout(e.Util.bind(this._resetState,this),0);var i=new e.LatLngBounds(this._map.containerPointToLatLng(this._startPoint),this._map.containerPointToLatLng(this._point));this._map.fire("areaSelect",{areaSelectBounds:i,event:t})}}});function _t(){}e.Map.addInitHook("addHandler","areaSelect",vt);var bt=_t.prototype;t.EventEmitter;function Lt(t,e){for(var i=t.length;i--;)if(t[i].listener===e)return i;return-1}function xt(t){return function(){return this[t].apply(this,arguments)}}bt.getListeners=function(t){var e,i,s=this._getEvents();if(t instanceof RegExp)for(i in e={},s)s.hasOwnProperty(i)&&t.test(i)&&(e[i]=s[i]);else e=s[t]||(s[t]=[]);return e},bt.flattenListeners=function(t){var e,i=[];for(e=0;e<t.length;e+=1)i.push(t[e].listener);return i},bt.getListenersAsObject=function(t){var e,i=this.getListeners(t);return i instanceof Array&&((e={})[t]=i),e||i},bt.addListener=function(t,e){if(!function t(e){return"function"==typeof e||e instanceof RegExp||!(!e||"object"!=typeof e)&&t(e.listener)}(e))throw new TypeError("listener must be a function");var i,s=this.getListenersAsObject(t),n="object"==typeof e;for(i in s)s.hasOwnProperty(i)&&-1===Lt(s[i],e)&&s[i].push(n?e:{listener:e,once:!1});return this},bt.on=xt("addListener"),bt.addOnceListener=function(t,e){return this.addListener(t,{listener:e,once:!0})},bt.once=xt("addOnceListener"),bt.defineEvent=function(t){return this.getListeners(t),this},bt.defineEvents=function(t){for(var e=0;e<t.length;e+=1)this.defineEvent(t[e]);return this},bt.removeListener=function(t,e){var i,s,n=this.getListenersAsObject(t);for(s in n)n.hasOwnProperty(s)&&-1!==(i=Lt(n[s],e))&&n[s].splice(i,1);return this},bt.off=xt("removeListener"),bt.addListeners=function(t,e){return this.manipulateListeners(!1,t,e)},bt.removeListeners=function(t,e){return this.manipulateListeners(!0,t,e)},bt.manipulateListeners=function(t,e,i){var s,n,r=t?this.removeListener:this.addListener,o=t?this.removeListeners:this.addListeners;if("object"!=typeof e||e instanceof RegExp)for(s=i.length;s--;)r.call(this,e,i[s]);else for(s in e)e.hasOwnProperty(s)&&(n=e[s])&&("function"==typeof n?r.call(this,s,n):o.call(this,s,n));return this},bt.removeEvent=function(t){var e,i=typeof t,s=this._getEvents();if("string"===i)delete s[t];else if(t instanceof RegExp)for(e in s)s.hasOwnProperty(e)&&t.test(e)&&delete s[e];else delete this._events;return this},bt.removeAllListeners=xt("removeEvent"),bt.emitEvent=function(t,e){var i,s,n,r,o=this.getListenersAsObject(t);for(r in o)if(o.hasOwnProperty(r))for(i=o[r].slice(0),n=0;n<i.length;n++)!0===(s=i[n]).once&&this.removeListener(t,s.listener),s.listener.apply(this,e||[])===this._getOnceReturnValue()&&this.removeListener(t,s.listener);return this},bt.trigger=xt("emitEvent"),bt.emit=function(t){var e=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,e)},bt.setOnceReturnValue=function(t){return this._onceReturnValue=t,this},bt._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},bt._getEvents=function(){return this._events||(this._events={})};var St=e.Marker.extend({initialize:function(t,i){e.Marker.prototype.initialize.call(this,t.latlng),this._map=t._map;var s=t.data;this.poolListener=[],this.assetCanMove=!1,this.assetCanSelect=!1,this.assetSelected=!1,this._initData(s,i),this._createObserver()},_initData:function(t,e){this.assetProperties=e,this.assetId=t.id,this.assetType=t.type,this.assetLatitude=t.latitude,this.assetLongitude=t.longitude},_createObserver:function(){this.assetObserver=new _t;var t={toggle:()=>{this.toggleSelect()},selected:()=>{this.assetSelected=!0},unSelected:()=>{this.assetSelected=!1}};this.assetObserver.addListeners(t)},_addEventListener:function(t){t.on("click",t=>{var e={originEvent:t,data:this.feature};this.assetObserver.emitEvent("click",[e])}),t.on("mouseover",t=>{var e={originEvent:t,data:this.feature};this.assetObserver.emitEvent("hover",e)}),t.on("mouseout",t=>{var e={originEvent:t,data:this.feature};this.assetObserver.emitEvent("hover",e)})},isSeleted:function(){return this.assetSelected},action:function(t){this.assetObserver.emitEvent(t.action,[t.data])},toggleSelect:function(){this.assetSelected=!this.assetSelected}});var wt=e.DivIcon.extend({initialize:function(t,i){var s={html:'<div class="leaflet-trains-station-asset"><div class="leaflet-trains-station-asset-name">'+i.name+'</div><img class="leaflet-trains-station-asset-img" src="assets/images/ic-marker-station.svg"></div>',iconSize:[24,24]};e.DivIcon.prototype.initialize.call(this,s)}}),Tt=St.extend({initialize:function(t,e){St.prototype.initialize.call(this,t,e);var i=t.data;this.assetCanMove=!1,this.assetCanSelect=!1,this.assetSelected=!1,this._createIcon(i)},_createIcon(t){const e=function(t,e){return new wt(t,e)}({},t);this.setIcon(e)}});function It(t,e){return new Tt(t,e)}var At=e.DivIcon.extend({initialize:function(t,i){var s=t.angle||0,n={html:'<div class="leaflet-trains-train-asset"><div class="leaflet-trains-train-asset-name">'+i.name+'</div><img class="leaflet-trains-train-asset-img" src="assets/images/ic-marker-train.svg"></div><div class="leaflet-trains-train-asset-or" style="transform: rotate('+s+'deg);"><div class="leaflet-trains-train-asset-arrow arrow-es"><div class="train-arrow"><div class="train-arrow-after"></div></div></div></div>',iconSize:[38,38],popupAnchor:[0,-41]};e.DivIcon.prototype.initialize.call(this,n)}}),Ct=St.extend({initialize:function(t,e){St.prototype.initialize.call(this,t,e);var i=t.popup,s=t.data;this.networkMap=t.networkMap||null,this.assetCanMove=!0,this.assetCanSelect=!0,this.assetSelected=!1,this._createIcon(s),this._createPopupEventSameTooltip(i,e)},_initData(t,e){this.assetProperties=e,this.assetId=t.id,this.assetType=t.type,this.assetLatitude=t.latitude,this.assetLongitude=t.longitude,this.assetName=t.name,this.assetLastStationId=t.lastStation.id,this.assetLastStationName=t.lastStation.name,this.assetLastStationLatitude=t.lastStation.latitude,this.assetLastStationLongitude=t.lastStation.longitude,this.assetNextStationId=t.nextStation.id,this.assetNextStationName=t.nextStation.name,this.assetNextStationLatitude=t.nextStation.latitude,this.assetNextStationLongitude=t.nextStation.longitude,this.assetRouteId=t.route.rountId,this.assetRouteName=t.route.routeName,this.assetRouteLineId=t.route.lineId,this.assetRouteLineName=t.route.lineName},_createPopup(t){var e=t.list||[{name:"Train No",field:"trainNo",value:this.assetsName},{name:"Last station",field:"lastStation",value:this.assetLastStationName},{name:"Next station",field:"nextStation",value:this.assetNextStationName}],i=this._getHtmlTemplatePopup(e);this.bindPopup(i,{minWidth:270,className:"leaflet-trains-popup"})},_createIcon(t){var e=function(t,e){return new At(t,e)}({angle:this._getAngleWithNextStation()},t);this.setIcon(e)},_createPopupEventSameTooltip(t,e){this._createPopup(t,e),this.on("mouseover",()=>{this._changeStyleWhenHover("#c6c6c6"),this.openPopup()}),this.on("mouseout",()=>{this._changeStyleWhenHover(""),this.closePopup()})},_changeStyleWhenHover(t){var e=this._icon.getElementsByClassName("leaflet-trains-train-asset"),i=this._icon.getElementsByClassName("leaflet-trains-train-asset-name"),s=this._icon.getElementsByClassName("train-arrow-after");e.length&&(e[0].style.backgroundColor=t),i&&i.length&&(i[0].style.backgroundColor=t),s&&s.length&&(s[0].style.borderBottomColor=t)},_getHtmlTemplatePopup(t){var e=t.reduce((t,e)=>t+='<li class="leaflet-trains-popup-list-item"><div class="leaflet-trains-popup-list-item-name">'+e.name+'</div><div class="leaflet-trains-popup-list-item-value">'+e.value+"</div></li>","");return'<div class="leaflet-trains-popup"><div class="leaflet-trains-popup-wrapper"><div class="leaflet-trains-popup-head"><span class="leaflet-trains-popup-head-name"></span><span class="leaflet-trains-popup-head-value">'+this.assetName+'</span></div><div class="leaflet-trains-popup-body"><ul class="leaflet-trains-popup-list"> '+e+" </ul></div></div></div>"},_getDirection(){var t=this._getLocationNetworkMap(),e=this.feature.properties.segment.departureStation,i=this.feature.properties.segment.arrivalStation,s=this.networkMap.getLayers()[0].feature.properties.Stations,n=s.findIndex(t=>t.station.id===e.id);return s.findIndex(t=>t.station.id===i.id)>n&&t.reverse(),t},_getAngle(){var t=this._getDirection(),e=this.getLatLng(),i=this._getLocationNearTrain(t,e),s=this._getPointNearNextTrain(t,i.index,e),n=i.location,r=s,o=t.length-1===i.index?[r,n]:[n,r],a=w(this._map,o);return S(a[0],a[1])},_getAngleWithNextStation(){var t=this.assetNextStationLongitude,i=this.assetNextStationLatitude,s=e.latLng(i,t),n=[this.getLatLng(),s],r=w(this._map,n);return S(r[0],r[1])},_getLocationNetworkMap(){return this.networkMap.getLayers().reduce((t,e)=>{var i=e.getLatLngs();return t=t.concat(i)},[])},_getLocationNearTrain:(t,e)=>t.reduce((t,i,s)=>{var n=i.distanceTo(e);return n>t.distance?t:{distance:n,location:i,index:s}},{distance:1/0,location:null,index:0}),_getPointNearNextTrain:(t,e,i)=>t[e+1]||i,updateData(t,e){this._initData(t,e),this.updatePosition([this.assetLatitude,this.assetLongitude]),this._createIcon(t)},updatePosition(t){var i=e.latLng(t);this.setLatLng(i)}});function kt(t,e){return new Ct(t,e)}var Ot=e.Control.Layers.extend({onAdd:function(){return this._initLayout(),this._update(),this._customizeOverlays(),this._container},_update:function(){if(!this._container)return this;e.DomUtil.empty(this._baseLayersList),e.DomUtil.empty(this._overlaysList),this._layerControlInputs=[];var t,i,s,n,r=0;for(s=this._layers.length-1;s>=0;s--)n=this._layers[s],this._addItem(n),i=i||n.overlay,t=t||!n.overlay,r+=n.overlay?0:1;return this.options.hideSingleBase&&(t=t&&r>1,this._baseLayersList.style.display=t?"":"none"),this._separator.style.display=i&&t?"":"none",this},_addItem:function(t){var i,s=document.createElement("label");t.overlay?((i=document.createElement("input")).type="checkbox",i.className="leaflet-control-layers-selector",i.defaultChecked=!0):i=this._createRadioElement("leaflet-base-layers",!0),this._layerControlInputs.push(i),i.layerId=e.Util.stamp(t.layer),e.DomEvent.on(i,"click",this._onInputClick,this);var n=document.createElement("span");n.innerHTML=" "+t.name;var r=document.createElement("div");s.appendChild(r),r.appendChild(i),r.appendChild(n);var o=this.createCustomizeOverlay(t.name);return r.appendChild(o),(t.overlay?this._overlaysList:this._baseLayersList).appendChild(s),this._checkDisabledLayers(),s},createCustomizeOverlay:function(t){var e=document.createElement("div");return e.className="leaflet-trains-overlays-layers-separator",e.innerHTML=this._getHTML(t),e},_getHTML(t){switch(t){case"Line":return'<svg width="100%" height="100%" viewBox="0 0 23 23" xmlns="http://www.w3.org/2000/svg"><path d="M11.028 18.5921h.2491v1.735h-.2891v1.7349H9.253v-1.735H2.8916v1.735h-1.735v-1.735H0v-1.7349h1.1566v-1.735H0v-1.7349h1.1566v-1.735H0v-1.7349h1.1566V9.9174H0v-1.735h1.1566V6.4476H0v-1.735h1.1566V2.9777H0V1.2427h1.1566V.0861h1.735v11.5662h.9653c.4651-.6008.9898-1.1792 1.5738-1.7349H4.2476v-1.735H7.55c.6264-.4517 1.1938-.9036 1.703-1.3556v-.3793H4.2475v-1.735H9.253V2.9777H4.2476V1.2427H9.253V.0861h1.735v1.1566h.2891v1.735h-.2891v1.7349h.222C12.3068 3.203 12.767 1.6904 12.6155.1722L14.342 0c.2643 2.6501-.8756 5.1794-3.354 7.5816v.6009h.2892v1.7349h-.2891v1.735h.2891v.9542c.6123-.9482 1.3627-1.845 2.25-2.6892h-.8042v-1.735h2.9236c.8016-.578 1.5065-1.1563 2.1163-1.7349H15.036v-1.735h4.2703c.4198-.5777.7463-1.156.981-1.7349h-4.0946V1.2427h4.524a5.6306 5.6306 0 0 0-.005-1.0705L22.4384 0a7.449 7.449 0 0 1 .0206 1.2427H23v1.735h-.868c-.1822.5847-.4365 1.163-.7622 1.7349h.6959v1.735h-1.919c-.4937.5855-1.065 1.1639-1.713 1.7349h.506v1.7349H16.213c-3.1954 2.4033-4.9081 5.2801-5.1849 8.6747zm-4.8825-6.9398H9.253V9.9174H8.1165c-.7353.553-1.3921 1.1312-1.971 1.735zm-3.2139 6.9398H9.253v-1.735H3.2091a11.192 11.192 0 0 0-.2775 1.735zm.8607-3.4699H9.253v-1.735H4.7432c-.3738.559-.6907 1.1373-.9509 1.735z" fill="#6F7BC6" fill-rule="nonzero"/></svg>';case"Stations":return'<svg width="100%" height="100%" viewBox="0 0 22 17" xmlns="http://www.w3.org/2000/svg"><g fill="#6f7bc6" fill-rule="evenodd"><path fill-rule="nonzero" d="M1.692 16h20v1h-20zM10.543 15.295H9.55a.553.553 0 0 1-.55-.556V4.019c0-.769.616-1.392 1.376-1.392h3.022v-.794h3.512v.794h3.022c.76 0 1.376.623 1.376 1.391v10.72a.553.553 0 0 1-.55.557H10.543zm1.919-1.539a.77.77 0 1 0-1.539 0 .77.77 0 0 0 1.539 0zm6.538.77a.77.77 0 1 0 0-1.539.77.77 0 0 0 0 1.539zm.504-4.616c.146 0 .265-.129.265-.288V4.044c0-.159-.119-.288-.265-.288h-8.7c-.147 0-.266.13-.266.288v5.578c0 .16.12.288.266.288h8.7z"/><path fill-rule="nonzero" d="M3.615 6.385h1.154V16.77H3.615z"/><path d="M4.192 6.885a3.385 3.385 0 1 1 0-6.77 3.385 3.385 0 0 1 0 6.77zm0-1a2.385 2.385 0 1 0 0-4.77 2.385 2.385 0 0 0 0 4.77z" fill-rule="nonzero"/><path d="M3.423 2.538h1.254c.274 0 .478.065.614.195s.204.315.204.555c0 .247-.074.44-.222.578-.148.139-.374.208-.679.208h-.413v.907h-.758V2.538zm.758 1.042h.185c.145 0 .248-.026.307-.076a.244.244 0 0 0 .088-.194.271.271 0 0 0-.077-.195c-.05-.053-.147-.08-.288-.08h-.215v.545z"/></g></svg>';case"Trains":return'<svg width="100%" height="100%" viewBox="0 0 37 35" xmlns="http://www.w3.org/2000/svg"><path d="M8.5006 28.4561H6.3794c-.6495 0-1.176-.5265-1.176-1.1761V4.619c0-1.624 1.3164-2.9404 2.9403-2.9404h6.4562V0h7.5046v1.6786h6.4563c1.6239 0 2.9403 1.3165 2.9403 2.9404V27.28c0 .6495-.5265 1.176-1.1761 1.176h-2.1212L36.7045 35H31.24l-6.66-6.5439H12.1244L5.4643 35H0l8.5006-6.5439zm3.6237-3.7083c0-.9951-.8067-1.802-1.802-1.802-.9951 0-1.8018.8068-1.8018 1.802 0 .9952.8067 1.802 1.8019 1.802.9952 0 1.8019-.8069 1.8019-1.802zm14.132 1.802c.9952 0 1.802-.8068 1.802-1.802 0-.9951-.8068-1.802-1.802-1.802-.9951 0-1.8019.8068-1.8019 1.802 0 .9951.8068 1.802 1.802 1.802zm1.7305-9.3171a.588.588 0 0 0 .588-.588V5.257a.588.588 0 0 0-.588-.588H8.7176a.588.588 0 0 0-.588.588v11.3876a.588.588 0 0 0 .588.588h19.2692z" fill="#6f7bc6" fill-rule="nonzero"/></svg>';default:return""}},_customizeOverlays:function(){var t=this._container;t.className=t.className+" leaflet-trains-overlays";var i=t.getElementsByTagName("label");[].forEach.call(i,t=>{var i=t.getElementsByTagName("div")[0];e.DomUtil.create("div","leaflet-trains-overlays-layers-separator",i).innerHTML='<svg width="100%" height="100%" viewBox="0 0 22 17" xmlns="http://www.w3.org/2000/svg"><g fill="#6f7bc6" fill-rule="evenodd"><path fill-rule="nonzero" d="M1.692 16h20v1h-20zM10.543 15.295H9.55a.553.553 0 0 1-.55-.556V4.019c0-.769.616-1.392 1.376-1.392h3.022v-.794h3.512v.794h3.022c.76 0 1.376.623 1.376 1.391v10.72a.553.553 0 0 1-.55.557H10.543zm1.919-1.539a.77.77 0 1 0-1.539 0 .77.77 0 0 0 1.539 0zm6.538.77a.77.77 0 1 0 0-1.539.77.77 0 0 0 0 1.539zm.504-4.616c.146 0 .265-.129.265-.288V4.044c0-.159-.119-.288-.265-.288h-8.7c-.147 0-.266.13-.266.288v5.578c0 .16.12.288.266.288h8.7z"/><path fill-rule="nonzero" d="M3.615 6.385h1.154V16.77H3.615z"/><path d="M4.192 6.885a3.385 3.385 0 1 1 0-6.77 3.385 3.385 0 0 1 0 6.77zm0-1a2.385 2.385 0 1 0 0-4.77 2.385 2.385 0 0 0 0 4.77z" fill-rule="nonzero"/><path d="M3.423 2.538h1.254c.274 0 .478.065.614.195s.204.315.204.555c0 .247-.074.44-.222.578-.148.139-.374.208-.679.208h-.413v.907h-.758V2.538zm.758 1.042h.185c.145 0 .248-.026.307-.076a.244.244 0 0 0 .088-.194.271.271 0 0 0-.077-.195c-.05-.053-.147-.08-.288-.08h-.215v.545z"/></g></svg>'})}}),Pt=function(t,e,i){return new Ot(t,e,i)};var Rt=function(t){return t.reduce((t,e)=>{var i=e.data,s={type:"Feature",geometry:{type:"Point",coordinates:[i.longitude,i.latitude]},id:i.id,properties:e};return t.features.push(s),t},{type:"FeatureCollection",features:[]})},Et=function(t){return t.reduce((t,e)=>{var i=e.data,s={type:"Feature",geometry:{type:"Point",coordinates:[i.longitude,i.latitude]},id:i.id,properties:e};return t.features.push(s),t},{type:"FeatureCollection",features:[]})};t.VERSION="1.0.14",t.Support=s,t.options=n,t.Util=G,t.get=p,t.post=l,t.request=h,t.Task=H,t.task=function(t){return t=F(t),new H(t)},t.Query=Z,t.query=J,t.Find=V,t.find=W,t.Identify=Q,t.identify=function(t){return new Q(t)},t.IdentifyFeatures=K,t.identifyFeatures=X,t.IdentifyImage=$,t.identifyImage=Y,t.Service=tt,t.service=function(t){return t=F(t),new tt(t)},t.MapService=et,t.mapService=it,t.ImageService=st,t.imageService=nt,t.FeatureLayerService=rt,t.featureLayerService=ot,t.BasemapLayer=lt,t.basemapLayer=ut,t.TiledMapLayer=ht,t.tiledMapLayer=function(t,e){return new ht(t,e)},t.RasterLayer=pt,t.ImageMapLayer=dt,t.imageMapLayer=function(t,e){return new dt(t,e)},t.DynamicMapLayer=ft,t.dynamicMapLayer=function(t,e){return new ft(t,e)},t.FeatureManager=gt,t.FeatureLayer=yt,t.featureLayer=function(t){return new yt(t)},t.AreaSelect=vt,t.BaseAsset=St,t.baseAsset=function(t,e){return new St(t,e)},t.StationAsset=Tt,t.stationAsset=It,t.TrainAsset=Ct,t.trainAsset=kt,t.EnouvoTrains=class{constructor(t,e){this.poolListener=[],this.layerSelected=new Proxy([],{set:(t,e,i,s)=>(t[e]=i,!0)}),this.networkMaps=[],this._createObserver(),this._createMap(t,e)}_createObserver(){this.observer=new _t;var t={toggleSelectTrain:t=>{this.poolListener.filter(t=>"toggleSelectTrain"===t.event).forEach(e=>{"function"==typeof e.action&&e.action(t)})},areaSelectTrains:t=>{this.poolListener.filter(t=>"areaSelectTrains"===t.event).forEach(e=>{if("function"==typeof e.action){let i=[];this.networkTrains.eachLayer(t=>{t.selected&&i.push(t.feature)}),e.action(t)}})},hoverTrain:t=>{this.poolListener.filter(t=>"hoverTrain"===t.event).forEach(e=>{"function"==typeof e.action&&e.action(t)})}};this.observer.addListeners(t)}_createMap(t,i){this._map=new e.Map(t,i),this._map._container.className=this._map._container.className+" leaflet-trains",this._map.zoomControl.setPosition("bottomleft"),this._createLayer(),this._createOverlayControl(),this._map.on("areaSelect",t=>{var e=t.areaSelectBounds,i={data:this._selectedAssetsWithBounds(e),action:"selected",originEvent:t.event};this.observer.emitEvent("areaSelectTrains",[i])})}_createLayer(){ut("Streets").addTo(this._map)}_createOverlayControl(){this.overlaysControl=Pt([],{},{position:"bottomleft",collapsed:!1}).addTo(this._map)}_addEventListenerMap(t,e){var i="LineString"===t.geometry.type?"Line: "+t.properties.name:"Train: "+t.properties.name;e.bindTooltip(i)}_onEachFeatureTrain(t,e){const i=t.properties.properties;this._addEventListenerTrain(e,i)}_addEventListenerTrain(t,e){t.on("click",t=>{var i=t.target,s=i.assetId;this.toggleAsset(s);var n={originEvent:t,action:i.isSeleted()?"selected":"unselected",data:e};this.observer.emitEvent("toggleSelectTrain",[n])}),t.on("mouseover",t=>{var i={originEvent:t,action:"hover",data:e};this.observer.emitEvent("hoverTrain",[i])}),t.on("mouseout",t=>{var i={originEvent:t,action:"unhover",data:e};this.observer.emitEvent("hoverTrain",[i])})}setNetworkMaps(t){var i=this;this.networkMapsData=t;var s=[];this.networkMaps=t.map(t=>{const n={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:t.paths},id:t.properties.id,properties:t.properties}]},r=new e.GeoJSON(n,{style:function(){return{weight:7}},onEachFeature:this._addEventListenerMap.bind(i)});return s.push(r),r.addTo(this._map),{id:t.properties.id,networkMap:r,name:t.properties.name}}),this.overlaysControl.addOverlay(e.layerGroup(s),"Line")}clearNetworkMaps(){this.networkMaps&&(this.networkMaps.clearLayers(),this.networkMapsData=null)}setNetworkStations(t){this.networkStationsData=Rt(t),this.networkStations=new e.GeoJSON(this.networkStationsData,{pointToLayer:(t,e)=>{var i=t.properties.properties;return It({latlng:e,data:{id:i.id,type:"STATION",name:i.stationName,latitude:i.latitude,longitude:i.longitude}},i)}}),this.networkStations.addTo(this._map),this.overlaysControl.addOverlay(this.networkStations,"Stations"),this.networkStations.setZIndex(2)}clearNetworkStations(){this.networkStations&&(this.networkStations.clearLayers(),this.networkStationsData=null)}setNetworkTrains(t){this.networkTrainsData=Et(t),this.networkTrains=new e.GeoJSON(this.networkTrainsData,{onEachFeature:this._onEachFeatureTrain.bind(this),pointToLayer:(t,e)=>{try{var i=t.properties.data,s=t.properties.properties,n=i.route.lineId,r=this.networkMaps.find(t=>t.id===n),o={id:i.id,type:"TRAIN",name:i.name,latitude:i.latitude,longitude:i.longitude,nextStation:{id:i.nextStation.id,name:i.nextStation.name,latitude:i.nextStation.latitude,longitude:i.nextStation.longitude},lastStation:{id:i.lastStation.id,name:i.lastStation.name,latitude:i.lastStation.latitude,longitude:i.lastStation.longitude},route:{routeId:i.routeId,rountName:i.rountName,lineId:i.lineId,lineName:i.lineName}};return kt({latlng:e,networkMap:r.networkMap,data:o,popup:t.properties.popup,_map:this._map},s)}catch(t){console.log(t)}}}),this.networkTrains.addTo(this._map),this.networkTrains.setZIndex(1e7),this.overlaysControl.addOverlay(this.networkTrains,"Trains")}addTrain(t){var i=t.data,s=t.properties,n=e.latLng(i.latitude,i.longitude),r=i.route.lineId,o=this.networkMaps.find(t=>t.id===r),a=kt(Object.assign(t,{networkMap:o.networkMap,_map:this._map,data:i,latlng:n}),s);a.addTo(this._map),this.networkTrains.addLayer(a),this._addEventListenerTrain(a,s)}updateTrain(t){var e=t.data,i=t.properties,s=this.networkTrains.getLayers().find(t=>t.assetId===e.id);return s&&s.updateData(e,i),s}replaceTrain(t){t&&(this.updateTrain(t)||this.addTrain(t))}clearNetworkTrains(){this.networkTrains&&(this.networkTrains.clearLayers(),this.networkTrainsData=null)}addListener(t){this.poolListener.push(t)}addListeners(t){this.poolListener=this.poolListener.concat(t)}setView(t,e,i){this._map.setView(t,e,i)}_selectedAssetsWithBounds(t){return this.networkTrains.getLayers().filter(e=>t.contains(e.getLatLng())).map(t=>(t.action&&t.action("selected"),t.assetProperties))}controlPopupAsset(t,e){this.networkTrains.eachLayer(i=>{i.assetId===t&&(e?i.openPopup():i.closePopup())})}toggleAsset(t){if(!t)throw new Error("assetId unvalid");var e=this.networkTrains.getLayers().find(e=>e.assetId===t);e.action&&e.action({action:"toggle"})}selectedAsset(t){var e=this.networkTrains.getLayers().find(e=>e.assetId===t);e.action&&e.action({action:"selected"})}selectedAssets(t){this.networkTrains.eachLayer(e=>{var i=t.find(t=>t===e.assetId&&e);i&&i.action&&i.action({action:"selected"})})}selectedAssetsAll(){this.networkTrains.eachLayer(t=>{t.action&&t.action({action:"selected"})})}unSelectedAsset(t){this.networkTrains.eachLayer(e=>{e.assetId===t&&e.action&&e.action({action:"unSelected"})})}unSelectedAssets(t){this.networkTrains.eachLayer(e=>{var i=t.find(t=>t===e.assetId&&e);i.action&&i.action({action:"unSelected"})})}unSelectedAssetsAll(){this.networkTrains.eachLayer(t=>{t.action&&t.action({action:"unSelected"})})}},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=leaflet-trains.js.map
